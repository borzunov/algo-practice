{% extends "algo/base.html" %}
{% load staticfiles %}

{% block title %}Submit {{ algorithm.name }} - {{ block.super }}{% endblock %}

{% block includes %}
<script src="{% static 'algo/lib/codemirror-5.3/lib/codemirror.js' %}"></script>
<link rel="stylesheet" href="{% static 'algo/lib/codemirror-5.3/lib/codemirror.css' %}" />
<script src="{% static 'algo/lib/codemirror-5.3/mode/clike/clike.js' %}"></script>
<script src="{% static 'algo/lib/codemirror-5.3/addon/scroll/simplescrollbars.js' %}"></script>
<link rel="stylesheet" href="{% static 'algo/lib/codemirror-5.3/addon/scroll/simplescrollbars.css' %}" />

<script src="//cdnjs.cloudflare.com/ajax/libs/diff_match_patch/20121119/diff_match_patch.js"></script>
<link rel="stylesheet" href="{% static 'algo/lib/codemirror-5.3/addon/merge/merge.css' %}" />
<script src="{% static 'algo/lib/codemirror-5.3/addon/merge/merge.js' %}"></script>
{% endblock %}

{% block content %}
<div class="navigation_box">
    &laquo; <a href="{% url 'algo:index' %}">Scoreboard</a>
    &laquo; <a href="{% url 'algo:check' algorithm_slug=algorithm.slug %}">Check {{ algorithm.name }}</a>
</div>

<div class="submit_content">
    <h3>Comparing {{ algorithm.name }}</h3>

    <div class="match_description">
        <div class="match_percents">Match: {{ score|floatformat:1 }}%</div>
        <div class="match_comment">
            * &ndash; Levenshtein distance by tokens: {{ distance }} (max {{ max_distance }})
        </div>
        <div class="submit_elapsed_time">Time: {{ elapsed_seconds }} seconds</div>
    </div>

    <div class="match_continue">
        <a class="match_continue_link" href="{% url 'algo:check' algorithm_slug=algorithm.slug %}">Try again</a>
        <a class="match_continue_link" href="{% url 'algo:check_random' %}">Try random</a>
    </div>

    <div class="submit_code_area">
        <div id="compare"><div>
    </div>
</div>

<script type="text/javascript">
    var BEFORE_REGION_LINES = {{ before_region_lines }};
    var AFTER_REGION_LINES = {{ after_region_lines }};

    function fillFrozenLines(editor) {
        for (var i = 0; i < BEFORE_REGION_LINES; i++)
            editor.addLineClass(i, 'background', 'line_predefined');
        var lineCount = editor.lineCount();
        for (var i = lineCount - AFTER_REGION_LINES - 1; i < lineCount; i++)
            editor.addLineClass(i, 'background', 'line_predefined');
    }

    function mergeViewHeight(mergeView) {
        function editorHeight(editor) {
            if (!editor)
                return 0;
            return editor.getScrollInfo().height;
        }
        return Math.max(
            editorHeight(mergeView.leftOriginal()),
            editorHeight(mergeView.editor()),
            editorHeight(mergeView.rightOriginal())
        );
    }

    function resizeMergeView(mergeView) {
        var codeElements = $('.CodeMirror-code');
        var newHeight = Math.max(
            codeElements.eq(0).height(),
            codeElements.eq(1).height()
        ) + 15;
        mergeView.leftOriginal().setSize(null, newHeight);
        mergeView.editor().setSize(null, newHeight);

        // mergeView.wrap.style.height = newHeight + "px";
    }

    function showMergeView() {
        var written_code = '{{ written_code|escapejs }}\n';
        var expected_code = '{{ expected_code|escapejs }}\n';
        var mergeView = CodeMirror.MergeView($('#compare')[0], {
            mode: "text/x-c++src",

            lineNumbers: true,
            lineWrapping: true,
            matchBrackets: true,
            showCursorWhenSelecting: true,

            readOnly: true,
            viewportMargin: Infinity,

            revertButtons: false,
            connect: 'align',
            collapseIdentical: 5,

            origLeft: written_code,
            value: expected_code,
        });

        fillFrozenLines(mergeView.leftOriginal());
        fillFrozenLines(mergeView.editor());

        $(window).resize(function () {
            resizeMergeView(mergeView);
        });
    }

    $(function () {
        showMergeView();
    });
</script>
{% endblock %}
